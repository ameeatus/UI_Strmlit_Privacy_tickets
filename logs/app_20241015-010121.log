2024-10-15 01:01:21,396 INFO root ScriptRunner.scriptThread : Log file created: C:\Users\5J4224897\Projects\UI_Strmlit_Privacy_tickets\logs/app_20241015-010121.log
2024-10-15 01:01:29,094 INFO root ScriptRunner.scriptThread : Log file created: C:\Users\5J4224897\Projects\UI_Strmlit_Privacy_tickets\logs/app_20241015-010129.log
2024-10-15 01:01:29,527 INFO snowflake.connector.connection ScriptRunner.scriptThread : Snowflake Connector for Python Version: 3.12.2, Python Version: 3.9.12, Platform: Windows-10-10.0.22631-SP0
2024-10-15 01:01:29,527 INFO snowflake.connector.connection ScriptRunner.scriptThread : Connecting to GLOBAL Snowflake domain
2024-10-15 01:01:29,529 INFO snowflake.connector.connection ScriptRunner.scriptThread : This connection is in OCSP Fail Open Mode. TLS Certificates would be checked for validity and revocation status. Any other Certificate Revocation related exceptions or OCSP Responder failures would be disregarded in favor of connectivity.
2024-10-15 01:01:30,560 INFO snowflake.connector.connection ScriptRunner.scriptThread : closed
2024-10-15 01:01:30,649 INFO snowflake.connector.connection ScriptRunner.scriptThread : No async queries seem to be running, deleting session
2024-10-15 01:01:31,953 INFO root ScriptRunner.scriptThread : Log file created: C:\Users\5J4224897\Projects\UI_Strmlit_Privacy_tickets\logs/app_20241015-010131.log
2024-10-15 01:01:32,326 INFO snowflake.connector.connection ScriptRunner.scriptThread : Snowflake Connector for Python Version: 3.12.2, Python Version: 3.9.12, Platform: Windows-10-10.0.22631-SP0
2024-10-15 01:01:32,326 INFO snowflake.connector.connection ScriptRunner.scriptThread : Connecting to GLOBAL Snowflake domain
2024-10-15 01:01:32,326 INFO snowflake.connector.connection ScriptRunner.scriptThread : This connection is in OCSP Fail Open Mode. TLS Certificates would be checked for validity and revocation status. Any other Certificate Revocation related exceptions or OCSP Responder failures would be disregarded in favor of connectivity.
2024-10-15 01:01:33,727 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-15 01:01:35,518 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-15 01:01:36,328 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 8
2024-10-15 01:01:36,594 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-15 01:01:37,005 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-15 01:01:38,859 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-15 01:01:38,859 INFO root ScriptRunner.scriptThread : Successfully uploaded 9 rows to 'INPUT_RECORDS' table in Snowflake.
2024-10-15 01:01:40,411 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 3
2024-10-15 01:01:40,411 INFO root ScriptRunner.scriptThread : Column - {column_name}  already exist in the table.
2024-10-15 01:01:40,411 INFO root ScriptRunner.scriptThread : Column - {column_name}  already exist in the table.
2024-10-15 01:01:40,411 INFO root ScriptRunner.scriptThread : Column - {column_name}  already exist in the table.
2024-10-15 01:01:40,411 INFO root ScriptRunner.scriptThread : Update Query: 
        UPDATE INPUT_RECORDS
        SET
            firstname_vector = SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', firstname),
            lastname_vector = SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', lastname),
            address_vector = SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m',address);
        
2024-10-15 01:01:41,621 INFO root ScriptRunner.scriptThread : Embeddings calculated and stored back in 'INPUT_RECORDS' table.
2024-10-15 01:01:41,621 INFO root ScriptRunner.scriptThread : Matching Rules Query: 
        WITH VECTOR_DATA AS (
        SELECT
            id,
            task_id,
            firstname,
            lastname,
            dob,
            GENDER,
            COUNTRY,
            firstname_vector,
            lastname_vector,
            address_vector
        FROM INPUT_RECORDS
        )
        SELECT
                a.task_id as task_id,
                A.id AS id_a,
                B.id AS id_b,
                A.DOB as dob_a,
                B.DOB as dob_b,
                A.GENDER as gender_a,
                B.GENDER as gender_b,
                A.firstname as firstname_a,
                B.firstname as firstname_b,
                A.lastname as lastname_a,
                B.lastname as lastname_b,
                A.firstname || ' ' || A.lastname || ' ' || A.DOB || ' ' || A.Gender || ' ' || A.COUNTRY AS first_record,
                B.firstname || ' ' || B.lastname || ' ' || B.DOB || ' ' || B.Gender || ' ' || B.COUNTRY AS second_record,
                CASE
                WHEN A.FIRSTNAME = B.FIRSTNAME
                    AND A.LASTNAME = B.LASTNAME
                    AND COALESCE(A.DOB,'11110101') = COALESCE(B.DOB,'11110101')
                    AND COALESCE(A.GENDER,'UNK') = COALESCE(B.GENDER,'UNK')
                THEN 'Exact firstname+lastname+dob+gender'
                when VECTOR_COSINE_SIMILARITY(A.firstname_vector,B.firstname_vector) > 0.95
                    AND VECTOR_COSINE_SIMILARITY(A.lastname_vector,B.lastname_vector) > 0.95
                    AND COALESCE(A.DOB,'11110101') = COALESCE(B.DOB,'11110101')
                    AND COALESCE(A.GENDER,'UNK') = COALESCE(B.GENDER,'UNK')
                THEN 'hc-firstname+hc-lastname | Exact DOB+gender'
                WHEN VECTOR_COSINE_SIMILARITY(A.ADDRESS_VECTOR, B.ADDRESS_VECTOR) > 0.9
                    AND VECTOR_COSINE_SIMILARITY(A.firstname_vector,B.firstname_vector) > 0.9
                    AND VECTOR_COSINE_SIMILARITY(A.lastname_vector,B.lastname_vector) > 0.9
                    AND COALESCE(A.DOB,'11110101') = COALESCE(B.DOB,'11110101')
                THEN 'lc firstname+lastname + hc-address  | Exact DOB+gender'
                WHEN EDITDISTANCE(A.LASTNAME, B.LASTNAME) < 3 
                THEN 'Fuzzy Match on Lastname'
                ELSE 'No Match'
                END AS MATCH_TYPE,
                VECTOR_COSINE_SIMILARITY(A.firstname_vector,B.firstname_vector) as fn_similarity_score,
                VECTOR_COSINE_SIMILARITY(A.lastname_vector,B.lastname_vector) as ln_similarity_score,
                VECTOR_COSINE_SIMILARITY(A.ADDRESS_VECTOR, B.ADDRESS_VECTOR) as adrs_similarity_score
            FROM VECTOR_DATA A
            JOIN VECTOR_DATA B ON A.id < B.id
            and A.task_id = B.task_id;
            
2024-10-15 01:01:41,890 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 10
2024-10-15 01:01:42,747 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 9
2024-10-15 01:01:42,779 INFO root ScriptRunner.scriptThread : Records grouped successfully
2024-10-15 01:01:43,613 INFO snowflake.connector.connection ScriptRunner.scriptThread : closed
2024-10-15 01:01:43,843 INFO snowflake.connector.connection ScriptRunner.scriptThread : No async queries seem to be running, deleting session
2024-10-16 06:49:12,702 INFO root ScriptRunner.scriptThread : Log file created: C:\Users\5J4224897\Projects\UI_Strmlit_Privacy_tickets\logs/app_20241016-064912.log
2024-10-16 06:49:19,723 INFO root ScriptRunner.scriptThread : Log file created: C:\Users\5J4224897\Projects\UI_Strmlit_Privacy_tickets\logs/app_20241016-064919.log
2024-10-16 06:49:20,680 INFO snowflake.connector.connection ScriptRunner.scriptThread : Snowflake Connector for Python Version: 3.12.2, Python Version: 3.9.12, Platform: Windows-10-10.0.22631-SP0
2024-10-16 06:49:20,681 INFO snowflake.connector.connection ScriptRunner.scriptThread : Connecting to GLOBAL Snowflake domain
2024-10-16 06:49:20,681 INFO snowflake.connector.connection ScriptRunner.scriptThread : This connection is in OCSP Fail Open Mode. TLS Certificates would be checked for validity and revocation status. Any other Certificate Revocation related exceptions or OCSP Responder failures would be disregarded in favor of connectivity.
2024-10-16 06:49:22,956 INFO snowflake.connector.connection ScriptRunner.scriptThread : closed
2024-10-16 06:49:23,141 INFO snowflake.connector.connection ScriptRunner.scriptThread : No async queries seem to be running, deleting session
2024-10-16 06:49:26,106 INFO root ScriptRunner.scriptThread : Log file created: C:\Users\5J4224897\Projects\UI_Strmlit_Privacy_tickets\logs/app_20241016-064926.log
2024-10-16 06:49:26,478 INFO snowflake.connector.connection ScriptRunner.scriptThread : Snowflake Connector for Python Version: 3.12.2, Python Version: 3.9.12, Platform: Windows-10-10.0.22631-SP0
2024-10-16 06:49:26,478 INFO snowflake.connector.connection ScriptRunner.scriptThread : Connecting to GLOBAL Snowflake domain
2024-10-16 06:49:26,478 INFO snowflake.connector.connection ScriptRunner.scriptThread : This connection is in OCSP Fail Open Mode. TLS Certificates would be checked for validity and revocation status. Any other Certificate Revocation related exceptions or OCSP Responder failures would be disregarded in favor of connectivity.
2024-10-16 06:49:27,257 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-16 06:49:28,485 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-16 06:49:29,166 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 8
2024-10-16 06:49:29,318 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-16 06:49:29,715 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-16 06:49:31,621 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 1
2024-10-16 06:49:31,623 INFO root ScriptRunner.scriptThread : Successfully uploaded 9 rows to 'INPUT_RECORDS' table in Snowflake.
2024-10-16 06:49:32,517 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 3
2024-10-16 06:49:32,517 INFO root ScriptRunner.scriptThread : Column - {column_name}  already exist in the table.
2024-10-16 06:49:32,517 INFO root ScriptRunner.scriptThread : Column - {column_name}  already exist in the table.
2024-10-16 06:49:32,517 INFO root ScriptRunner.scriptThread : Column - {column_name}  already exist in the table.
2024-10-16 06:49:32,517 INFO root ScriptRunner.scriptThread : Update Query: 
        UPDATE INPUT_RECORDS
        SET
            firstname_vector = SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', firstname),
            lastname_vector = SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m', lastname),
            address_vector = SNOWFLAKE.CORTEX.EMBED_TEXT_768('snowflake-arctic-embed-m',address);
        
2024-10-16 06:49:34,502 INFO root ScriptRunner.scriptThread : Embeddings calculated and stored back in 'INPUT_RECORDS' table.
2024-10-16 06:49:34,502 INFO root ScriptRunner.scriptThread : Matching Rules Query: 
        WITH VECTOR_DATA AS (
        SELECT
            id,
            task_id,
            firstname,
            lastname,
            dob,
            GENDER,
            COUNTRY,
            firstname_vector,
            lastname_vector,
            address_vector
        FROM INPUT_RECORDS
        )
        SELECT
                a.task_id as task_id,
                A.id AS id_a,
                B.id AS id_b,
                A.DOB as dob_a,
                B.DOB as dob_b,
                A.GENDER as gender_a,
                B.GENDER as gender_b,
                A.firstname as firstname_a,
                B.firstname as firstname_b,
                A.lastname as lastname_a,
                B.lastname as lastname_b,
                A.firstname || ' ' || A.lastname || ' ' || A.DOB || ' ' || A.Gender || ' ' || A.COUNTRY AS first_record,
                B.firstname || ' ' || B.lastname || ' ' || B.DOB || ' ' || B.Gender || ' ' || B.COUNTRY AS second_record,
                CASE
                WHEN A.FIRSTNAME = B.FIRSTNAME
                    AND A.LASTNAME = B.LASTNAME
                    AND COALESCE(A.DOB,'11110101') = COALESCE(B.DOB,'11110101')
                    AND COALESCE(A.GENDER,'UNK') = COALESCE(B.GENDER,'UNK')
                THEN 'Exact firstname+lastname+dob+gender'
                when VECTOR_COSINE_SIMILARITY(A.firstname_vector,B.firstname_vector) > 0.95
                    AND VECTOR_COSINE_SIMILARITY(A.lastname_vector,B.lastname_vector) > 0.95
                    AND COALESCE(A.DOB,'11110101') = COALESCE(B.DOB,'11110101')
                    AND COALESCE(A.GENDER,'UNK') = COALESCE(B.GENDER,'UNK')
                THEN 'hc-firstname+hc-lastname | Exact DOB+gender'
                WHEN VECTOR_COSINE_SIMILARITY(A.ADDRESS_VECTOR, B.ADDRESS_VECTOR) > 0.9
                    AND VECTOR_COSINE_SIMILARITY(A.firstname_vector,B.firstname_vector) > 0.9
                    AND VECTOR_COSINE_SIMILARITY(A.lastname_vector,B.lastname_vector) > 0.9
                    AND COALESCE(A.DOB,'11110101') = COALESCE(B.DOB,'11110101')
                THEN 'lc firstname+lastname + hc-address  | Exact DOB+gender'
                WHEN EDITDISTANCE(A.LASTNAME, B.LASTNAME) < 3 
                THEN 'Fuzzy Match on Lastname'
                ELSE 'No Match'
                END AS MATCH_TYPE,
                VECTOR_COSINE_SIMILARITY(A.firstname_vector,B.firstname_vector) as fn_similarity_score,
                VECTOR_COSINE_SIMILARITY(A.lastname_vector,B.lastname_vector) as ln_similarity_score,
                VECTOR_COSINE_SIMILARITY(A.ADDRESS_VECTOR, B.ADDRESS_VECTOR) as adrs_similarity_score
            FROM VECTOR_DATA A
            JOIN VECTOR_DATA B ON A.id < B.id
            and A.task_id = B.task_id;
            
2024-10-16 06:49:34,835 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 10
2024-10-16 06:49:34,988 INFO snowflake.connector.cursor ScriptRunner.scriptThread : Number of results in first chunk: 9
2024-10-16 06:49:35,005 INFO root ScriptRunner.scriptThread : Records grouped successfully
2024-10-16 06:49:35,043 INFO snowflake.connector.connection ScriptRunner.scriptThread : closed
2024-10-16 06:49:35,095 INFO snowflake.connector.connection ScriptRunner.scriptThread : No async queries seem to be running, deleting session
